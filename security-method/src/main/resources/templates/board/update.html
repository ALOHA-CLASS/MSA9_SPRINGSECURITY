<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
</head>
<body>
    <h1>ê²Œì‹œê¸€ ìˆ˜ì •</h1>
    <form action="/board/update" method="post" id="form">
        <!-- ğŸ’ CSRF TOKEN -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        
        <input type="hidden" name="id" th:value="${board.id}">
        <table border="1">
            <tr>
                <th>ì œëª©</th>
                <td>
                    <input type="text" name="title" th:value="${board.title}">
                </td>
            </tr>
            <tr>
                <th>ì‘ì„±ì</th>
                <td>
                    <input type="text" name="writer" th:value="${customUser.user.name}" disabled>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <textarea name="content" rows="5" cols="40" th:text="${board.content}"></textarea>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <!-- ğŸ‘®â€â™€ï¸ ê´€ë¦¬ì -->
                    <th:block sec:authorize="( hasRole('ADMIN') )">
                        <button type="submit">ìˆ˜ì •</button>
                        <button type="button" onclick="remove()">ì‚­ì œ</button>
                    </th:block>
                    <!-- ğŸ‘©â€ğŸ«ê²Œì‹œê¸€ ì†Œìœ ì -->
                    <th:block th:if="${ @BoardService.isOwner( board.id, #authentication.principal.user.no) }">
                        <button type="submit">ìˆ˜ì •</button>
                        <button type="button" onclick="remove()">ì‚­ì œ</button>
                    </th:block>
                    <button type="button" onclick="location.href='/board/list'">ëª©ë¡</button>
                </td>
            </tr>
        </table>
        <h3>íŒŒì¼ëª©ë¡</h3>
        <section id="file-list">
            <table border="1">
                <tr>
                    <th>no</th>
                    <th>
                        <input type="checkbox" id="delete-all" onclick="checkAll()">
                    </th>
                    <th>ì´ë¯¸ì§€</th>
                    <th>íŒŒì¼ëª…</th>
                    <th>ìš©ëŸ‰</th>
                    <th>íƒ€ì…</th>
                    <th>ì•¡ì…˜</th>
                </tr>
                <th:block th:if="${fileList == null || fileList.isEmpty()}">
                    <tr>
                        <td colspan="7" align="center">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                </th:block>
                <th:block th:each="file : ${fileList}">
                    <tr>
                        <td><span th:text="${file.no}"></span></td>
                        <td>
                            <input type="checkbox" class="delete-file" name="deleteFiles" th:value="${file.id}">
                        </td>
                        <td>
                            <img th:src="|/img?id=${file.id}|" height="100"  alt="íŒŒì¼ ì´ë¯¸ì§€">
                        </td>
                        <td><span th:text="${file.fileName}"></span></td>
                        <td><span th:text="${file.fileSize}"></span></td>
                        <td><span th:text="${file.type}"></span></td>
                        <td>
                            <button type="button" th:onclick="download( [[${file.id}]] )">ë‹¤ìš´ë¡œë“œ</button>
                            <button type="button" th:onclick="removeFile( this, [[${file.id}]] )">ì‚­ì œ</button>
                        </td>
                    </tr>
                </th:block>
            </table>
        </section>
    </form>

    <script>
        const form = document.getElementById('form')

        // ê²Œì‹œê¸€ ì‚­ì œ
        function remove() {
            if( !confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?') )
                return
            
            form.action = '/board/delete'   // action ì†ì„± ë³€ê²½
            form.submit()                   // ìš”ì²­ ì „ì†¡
        }


         // ë‹¤ìš´ë¡œë“œ
         function download( id ) {
            location.href = `/file/${id}`
        }

        // íŒŒì¼ ì‚­ì œ
        function removeFile( element, id ) {
            let request = new XMLHttpRequest()

            request.onreadystatechange = function() {

                // ìš”ì²­ ì™„ë£Œ ë° ì„±ê³µ
                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText
                    if( response == 'SUCCESS' ) {
                        alert('íŒŒì¼ ì‚­ì œ ì„±ê³µ')
                        // íŒŒì¼ ëª©ë¡ ê°±ì‹ 
                        // ë°©ë²•1 - í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                        // location.reload()

                        // ë°©ë²•2 - DOM ìœ¼ë¡œ íŒŒì¼í•­ëª© í–‰ ì‚­ì œ
                        // element.parentNode.parentNode.remove()  // button > td > tr
                        
                        // ë°©ë²•3 - íŒŒì¼ëª©ë¡ ë¹„ë™ê¸°ë¡œ ìš”ì²­
                        // 1ï¸âƒ£ JSON ë°ì´í„°ë¥¼ ë°›ê³  ë Œë”ë§
                        // 2ï¸âƒ£ íŒŒì¼ëª©ë¡ ë·°(html)ë¥¼ ì‘ë‹µë°›ì•„ ë Œë”ë§ â­
                        getFileList()
                    }
                    else {
                        alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨')
                    }
                }
            }
            const url = `/file/${id}`
            request.open('DELETE', url, true)
            request.send()
        }

        // íŒŒì¼ ëª©ë¡ ë¹„ë™ê¸° ìš”ì²­ 
        function getFileList() {
            let parentTable = 'board'
            let parentNo = '[[${board.no}]]'
            let url = `/file?parentTable=${parentTable}&parentNo=${parentNo}`

            let request = new XMLHttpRequest()

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log('íŒŒì¼ ëª©ë¡ ê°±ì‹  ì„±ê³µ');
                    let fileList = request.responseText
                    let $fileList = document.getElementById('file-list')
                    $fileList.innerHTML = ""        // ê¸°ë³¸ íŒŒì¼ ëª©ë¡ ë¹„ìš°ê¸°
                    $fileList.innerHTML = fileList  // ìƒˆë¡œ ì¡°íšŒí•œ íŒŒì¼ëª©ë¡ìœ¼ë¡œ ê°±ì‹ 
                }
            }
            request.open('GET', url, true)
            request.send()
        }

        // ì „ì²´ ì„ íƒ - ì‚­ì œí•  íŒŒì¼ ì „ë¶€ ì„ íƒ
        function checkAll() {
            // ì „ì²´ ì²´í¬ë°•ìŠ¤ âœ…
            const $deleteAll = document.getElementById('delete-all')

            // ê°œë³„ íŒŒì¼ ì‚­ì œ ì²´í¬ë°•ìŠ¤ âœ…
            const $deleteFile = document.getElementsByClassName('delete-file')

            // ì „ì²´ ì„ íƒ
            if( $deleteAll.checked ) {
                for (let i = 0; i < $deleteFile.length; i++) {
                    const checkbox = $deleteFile[i];
                    checkbox.checked = true
                }
            }
            // ì „ì²´ ì„ íƒ í•´ì œ
            else {
                for (let i = 0; i < $deleteFile.length; i++) {
                    const checkbox = $deleteFile[i];
                    checkbox.checked = false
                }
            }
        }

        
    </script>
</body>
</html>