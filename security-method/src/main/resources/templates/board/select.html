<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ì¡°íšŒ</title>
</head>
<body>
    <h1>ê²Œì‹œê¸€ ì¡°íšŒ</h1>
    <form action="" method="post">
        <table border="1">
            <input type="hidden" name="userNo" th:value="${board.user.no}">
            <tr>
                <th>ì œëª©</th>
                <td>
                    <input type="text" name="title" th:value="${board.title}">
                </td>
            </tr>
            <tr>
                <th>ì‘ì„±ì</th>
                <td>
                    <input type="text" th:value="${board.user.name}">
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <textarea name="content" rows="5" cols="40" th:text="${board.content}"></textarea>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <!-- ğŸ‘®â€â™€ï¸ ê´€ë¦¬ì -->
                    <th:block sec:authorize="( hasRole('ADMIN') )">
                        <button type="button" th:onclick="update()">ìˆ˜ì •</button>
                    </th:block>
                    <!-- ğŸ‘©â€ğŸ«ê²Œì‹œê¸€ ì†Œìœ ì -->
                    <th:block th:if="${ @BoardService.isOwner( board.id, #authentication.principal.user.no) }">
                        <button type="button" th:onclick="update()">ìˆ˜ì •</button>
                    </th:block>
                    <button type="button" onclick="location.href='/board/list'">ëª©ë¡</button>
                </td>
            </tr>
        </table>
        
        <h3>íŒŒì¼ëª©ë¡</h3>
        <section id="file-list">
            <table border="1">
                <tr>
                    <th>no</th>
                    <!-- <th>id</th> -->
                    <th>ì´ë¯¸ì§€</th>
                    <th>íŒŒì¼ëª…</th>
                    <th>ìš©ëŸ‰</th>
                    <th>íƒ€ì…</th>
                    <th>ì•¡ì…˜</th>
                </tr>
                <th:block th:if="${fileList == null || fileList.isEmpty()}">
                    <tr>
                        <td colspan="6" align="center">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                </th:block>
                <th:block th:each="file : ${fileList}">
                    <tr>
                        <td><span th:text="${file.no}"></span></td>
                        <!-- <td><span th:text="${file.id}"></span></td> -->
                        <td>
                            <img th:src="|/img?id=${file.id}|" height="100"  alt="íŒŒì¼ ì´ë¯¸ì§€">
                        </td>
                        <td><span th:text="${file.fileName}"></span></td>
                        <td><span th:text="${file.fileSize}"></span></td>
                        <td><span th:text="${file.type}"></span></td>
                        <td>
                            <button type="button" th:onclick="download( [[${file.id}]] )">ë‹¤ìš´ë¡œë“œ</button>
                        </td>
                    </tr>
                </th:block>
            </table>
        </section>

    </form>
    <h3>ëŒ“ê¸€ëª©ë¡</h3>
    <section id="comment-list">

    </section>

    <section id="comment-form">
        <form action="">
            <table>
                <tr>
                    <td>ì‘ì„±ì</td>
                    <td>
                        <input type="text" name="writer" id="writer">
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <textarea name="content" id="content" rows="5" cols="40"></textarea>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" align="right">
                        <button type="button" onclick="insertComment()">ë“±ë¡</button>
                    </td>
                </tr>
            </table>
        </form>
    </section>
    <div style="height: 300px;"></div>

    <!-- â­ Java ê°ì²´ â¡ JavaScript ê°ì²´ë¡œ ì „ë‹¬í•˜ê¸° -->
    <!-- <script th:inline="javascript">
        let board = [[${board}]]
        console.dir(board)
        console.log(board.title);
    </script> -->


    <script>

        // ìˆ˜ì • í™”ë©´ ì´ë™
        function update() {
            let id = "[[${board.id}]]"
            location.href = "/board/update?id=" + id
        }

        // ë‹¤ìš´ë¡œë“œ
        function download( id ) {
            location.href = `/file/${id}`
        }

        // íŒŒì¼ ëª©ë¡ ë¹„ë™ê¸° ìš”ì²­ 
        function getFileList() {
            let parentTable = 'board'
            let parentNo = '[[${board.no}]]'
            let url = `/file?parentTable=${parentTable}&parentNo=${parentNo}`

            let request = new XMLHttpRequest()

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log('íŒŒì¼ ëª©ë¡ ê°±ì‹  ì„±ê³µ');
                    let fileList = request.responseText
                    let $fileList = document.getElementById('file-list')
                    $fileList.innerHTML = ""        // ê¸°ë³¸ íŒŒì¼ ëª©ë¡ ë¹„ìš°ê¸°
                    $fileList.innerHTML = fileList  // ìƒˆë¡œ ì¡°íšŒí•œ íŒŒì¼ëª©ë¡ìœ¼ë¡œ ê°±ì‹ 
                }
            }
            request.open('GET', url, true)
            request.send()
        }

        // ëŒ“ê¸€ ë“±ë¡
        function insertComment() {
            const boardNo = "[[${board.no}]]"
            let writer = document.getElementById('writer').value
            let content = document.getElementById('content').value
            console.log(`writer : ${writer}`);
            console.log(`content : ${content}`);

            let data = {
                'boardNo' : boardNo,
                'writer' : writer,
                'content' : content
            }

            let request = new XMLHttpRequest()
            let url = '/comment'
            request.open('POST', url, true)
            request.setRequestHeader('Content-Type', 'application/json')
            request.send( JSON.stringify(data) )

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText
                    if( response == 'SUCCESS' ) {
                        console.log('ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ');
                        // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                        commentList()

                        // ì…ë ¥í•œ ì‘ì„±ì, ë‚´ìš© ë¹„ìš°ê¸°
                        document.getElementById('writer').value = ""
                        document.getElementById('content').value = ""
                    }
                }
            }
            
        }

        // ëŒ“ê¸€ ëª©ë¡
        commentList()
        function commentList() {
            let request = new XMLHttpRequest()
            let boardNo = "[[ ${board.no} ]]"
            let url = `/comment?boardNo=${boardNo}`
            request.open('GET', url, true)
            request.send()

            request.onreadystatechange = function() {
                let commentList = request.responseText
                let $commentList = document.getElementById('comment-list')
                $commentList.innerHTML = commentList
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        function removeComment( id ) {
            let request = new XMLHttpRequest()
            let url = `/comment/${id}`
            request.open('DELETE', url, true)
            request.send()
            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText
                    if( response == 'SUCCESS' ) {
                        console.log('ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ');
                        commentList()
                    }
                    else {
                        alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨')
                    }
                }
            }
        }
        
        // ëŒ“ê¸€ [ìˆ˜ì •] ë²„íŠ¼ í´ë¦­ ì‹œ - ìˆ˜ì • í¼ìœ¼ë¡œ ì „í™˜
        function editComment( button, id ) {
            console.log(button);
            let $table = button.closest('table')
            console.log($table);

            // ê¸°ì¡´ ì‘ì„±ìì™€ ê¸°ì¡´ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê¸°
            let writer = $table.querySelector('.comment-writer').textContent
            let content = $table.querySelector('.comment-content').textContent
            
            // ê¸°ì¡´ ì¡°íšŒ í¼ì€ ìˆ¨ê¹€
            $table.style.display = 'none'

            // ìˆ˜ì • í¼ ì‚½ì…
            let updateForm = `
                <table>
                    <tr>
                        <td>
                            <input type="text" name="writer" id="comment-writer" value="${writer}" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <textarea name="content" id="comment-content" rows="5" cols="40">${content}</textarea>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">
                            <button type="button" onclick=" updateComment( '${id}' ) ">ìˆ˜ì •</button>           
                            <button type="button" onclick=" cancelComment( this )">ì·¨ì†Œ</button>
                        </td>
                    </tr>
                </table>
            `
            // DOM ë…¸ë“œëŠ” after() í•¨ìˆ˜ë¡œ ë‹¤ìŒ ìš”ì†Œë¡œ ì¶”ê°€
            // $table.after(updateForm)
            // í…ìŠ¤íŠ¸ë¡œëœ html ì½”ë“œë¥¼ ë‹¤ìŒ ìš”ì†Œë¡œ ì¶”ê°€
            $table.insertAdjacentHTML("afterend", updateForm)
            
        }

        // ëŒ“ê¸€ ìˆ˜ì • ìš”ì²­  
        function updateComment( id ) {
            console.log(`id : ${id}`);
            let commentWriter = document.getElementById('comment-writer').value
            let commentContent = document.getElementById('comment-content').value
            let data = {
                'id'    : id,
                'writer' : commentWriter,
                'content' : commentContent
            }

            let request = new XMLHttpRequest()
            let url = '/comment'
            request.open('PUT', url, true)
            request.setRequestHeader('Content-Type', 'application/json')
            request.send( JSON.stringify(data) )

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText
                    if( response == 'SUCCESS' ) {
                        console.log('ëŒ“ê¸€ ìˆ˜ì • ì„±ê³µ');
                        commentList() // ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ 
                    }
                    else {
                        alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨')
                    }
                }
            }
            
        }

        // ëŒ“ê¸€ ìˆ˜ì • ì¤‘ - ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
        function cancelComment( cancelButton ) {
            // ìˆ˜ì •í¼
            let $table = cancelButton.closest('table')

            // ì¡°íšŒí¼
            let $comment = $table.previousElementSibling  // ë°”ë¡œ ì•ì˜ í˜•ì œìë§¤ ìš”ì†Œ

            $comment.style.display = 'table'    // ì¡°íšŒí¼ ë³´ì—¬ì£¼ê¸°
            $table.remove()                     // ìˆ˜ì •í¼ ì œê±°

        }

        // ë‹µê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ - ë‹µê¸€ ë“±ë¡ í¼ ì¶”ê°€
        function insertReply( insertButton, parentNo ) {
            let $table = insertButton.closest('table')  // ì¡°íšŒ í¼ 

            let insertForm = `
                <table class="reply-form">
                    <tr>
                        <td>
                            <input type="text" name="writer" id="reply-writer" />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <textarea name="content" id="reply-content" rows="5" cols="40"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">
                            <button type="button" onclick=" createReply( ${parentNo} ) ">ë“±ë¡</button>           
                            <button type="button" onclick=" cancelComment( this )">ì·¨ì†Œ</button>
                        </td>
                    </tr>
                </table>
            `
            // ë‹µê¸€ ë“±ë¡ í¼ì´ ì—¬ëŸ¬ê°œ ìƒê¸°ì§€ ì•Šë„ë¡ ê¸°ì¡´ ë“±ë¡ í¼ ì œê±°
            let replyForms = document.getElementsByClassName('reply-form')
            for (let i  = 0; i < replyForms.length; i++) {
                const replyForm = replyForms[i];
                replyForm.remove()
            }

            // í…ìŠ¤íŠ¸ë¡œëœ html ì½”ë“œë¥¼ ë‹¤ìŒ ìš”ì†Œë¡œ ì¶”ê°€
            $table.insertAdjacentHTML("afterend", insertForm)
        }
        
        // ë‹µê¸€ ë“±ë¡ ìš”ì²­
        function createReply( parentNo ) {
            let boardNo = "[[${board.no}]]"
            let writer = document.getElementById('reply-writer').value
            let content = document.getElementById('reply-content').value

            let data = {
                parentNo : parentNo,
                boardNo : boardNo,
                writer : writer,
                content : content
            }

            let request = new XMLHttpRequest()
            let url = "/comment"
            request.open("POST", url, true)
            request.setRequestHeader('Content-Type', 'application/json')
            request.send( JSON.stringify(data) )

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ){
                    let response = request.responseText
                    if( response == 'SUCCESS' ) {
                        console.log('ë‹µê¸€ ë“±ë¡ ì„±ê³µ');
                        commentList()
                    }
                    else {
                        alert('ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨')
                    }
                }
            }
        }
     </script>

</body>
</html>
